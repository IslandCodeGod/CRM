{% extends "base.html" %}

{% block title %}<span data-i18n="contact.title">Contact Management</span> - <span data-i18n="app.name">CRM
    System</span>{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title" data-i18n="contact.title">Contact Management</h1>
    <p class="page-subtitle" data-i18n="contact.subtitle">Manage customer contacts</p>
</div>

<div class="toolbar">
    <button class="btn btn-primary" onclick="openAddModal()">
        <span>➕</span>
        <span data-i18n="contact.add">Add Contact</span>
    </button>
</div>

<div class="card">
    <div id="contactTable"></div>
    <div id="pagination" class="pagination"></div>
</div>

<!-- 添加/编辑联系人模态框 -->
<div class="modal-overlay" id="contactModal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle" data-i18n="contact.add">Add Contact</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="contactForm" onsubmit="saveContact(event)">
            <input type="hidden" id="contactId">

            <div class="form-group">
                <label for="name" class="form-label"><span data-i18n="contact.name">Name</span> <span
                        data-i18n="common.required">*</span></label>
                <input type="text" id="name" class="form-control" required>
            </div>

            <div class="form-group">
                <label for="customer_id" class="form-label"><span data-i18n="contact.customer">Customer</span> <span
                        data-i18n="common.required">*</span></label>
                <select id="customer_id" class="form-control" required>
                    <option value="" data-i18n="opportunity.select_customer">Select Customer</option>
                </select>
            </div>

            <div class="form-group">
                <label for="position" class="form-label" data-i18n="contact.position">Position</label>
                <input type="text" id="position" class="form-control">
            </div>

            <div class="form-group">
                <label for="email" class="form-label" data-i18n="contact.email">Email</label>
                <input type="email" id="email" class="form-control">
            </div>

            <div class="form-group">
                <label for="phone" class="form-label" data-i18n="contact.phone">Phone</label>
                <input type="tel" id="phone" class="form-control">
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="is_primary">
                    <span data-i18n="contact.set_primary">Set as primary contact</span>
                </label>
            </div>

            <div class="flex gap-2">
                <button type="submit" class="btn btn-primary" data-i18n="action.save">Save</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()"
                    data-i18n="action.cancel">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    let currentPage = 1;
    let modal;
    let yesText, noText;

    document.addEventListener('DOMContentLoaded', () => {
        modal = new Modal('contactModal');
        // 初始化翻译文本，确保t()函数可用
        yesText = t('common.yes');
        noText = t('common.no');
    });

    async function loadContacts(page = 1) {
        currentPage = page;
        showLoading();

        try {
            const params = new URLSearchParams({ page: page, per_page: 10 });
            const data = await apiRequest(`/contacts/api/list?${params}`);
            renderContactTable(data.contacts);
            renderPagination('pagination', data.current_page, data.pages, 'loadContacts');
        } catch (error) {
            console.error('Failed to load contacts:', error);
        } finally {
            hideLoading();
        }
    }

    function renderContactTable(contacts) {
        const container = document.getElementById('contactTable');

        let html = '<div class="table-wrapper"><table class="table">';
        html += `
        <thead>
            <tr>
                <th data-i18n="contact.name">Name</th>
                <th data-i18n="contact.customer">Customer</th>
                <th data-i18n="contact.position">Position</th>
                <th data-i18n="contact.email">Email</th>
                <th data-i18n="contact.phone">Phone</th>
                <th data-i18n="contact.is_primary">Primary Contact</th>
                <th data-i18n="common.actions">Actions</th>
            </tr>
        </thead>
        <tbody>
    `;

        if (contacts.length === 0) {
            html += '<tr><td colspan="7" class="text-center" data-i18n="message.no_data">No data available</td></tr>';
        } else {
            contacts.forEach(contact => {
                html += `
                <tr>
                    <td><strong>${contact.name}</strong></td>
                    <td>${contact.customer_name || '-'}</td>
                    <td>${contact.position || '-'}</td>
                    <td>${contact.email || '-'}</td>
                    <td>${contact.phone || '-'}</td>
                    <td>${contact.is_primary ? `<span class="badge badge-success">${yesText}</span>` : `<span class="badge badge-secondary">${noText}</span>`}</td>
                    <td class="data-item-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editContact(${contact.id})" data-i18n="action.edit">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteContact(${contact.id})" data-i18n="action.delete">Delete</button>
                    </td>
                </tr>
            `;
            });
        }

        html += '</tbody></table></div>';
        container.innerHTML = html;

        if (typeof updatePageLanguage === 'function') {
            updatePageLanguage();
        }
    }

    async function loadCustomers() {
        try {
            const data = await apiRequest('/customers/api/list?per_page=100');
            const select = document.getElementById('customer_id');

            select.innerHTML = `<option value="" data-i18n="opportunity.select_customer">${t('opportunity.select_customer')}</option>`;
            data.customers.forEach(customer => {
                select.innerHTML += `<option value="${customer.id}">${customer.name} - ${customer.company || t('customer.no_company')}</option>`;
            });
        } catch (error) {
            console.error('Failed to load customers:', error);
        }
    }

    function openAddModal() {
        if (!modal) {
            console.error('Modal not initialized');
            return;
        }
        document.getElementById('modalTitle').setAttribute('data-i18n', 'contact.add');
        document.getElementById('modalTitle').textContent = t('contact.add');
        document.getElementById('contactForm').reset();
        document.getElementById('contactId').value = '';
        loadCustomers();
        modal.open();
    }

    async function editContact(id) {
        try {
            const contact = await apiRequest(`/contacts/api/${id}`);

            document.getElementById('modalTitle').setAttribute('data-i18n', 'contact.edit');
            document.getElementById('modalTitle').textContent = t('contact.edit');
            document.getElementById('contactId').value = contact.id;
            document.getElementById('name').value = contact.name;
            document.getElementById('position').value = contact.position || '';
            document.getElementById('email').value = contact.email || '';
            document.getElementById('phone').value = contact.phone || '';
            document.getElementById('is_primary').checked = contact.is_primary;

            await loadCustomers();
            document.getElementById('customer_id').value = contact.customer_id;

            if (modal) {
                modal.open();
            } else {
                console.error('Modal not initialized');
            }
        } catch (error) {
            console.error('Failed to load contact:', error);
        }
    }

    async function saveContact(event) {
        event.preventDefault();

        const id = document.getElementById('contactId').value;
        const data = {
            name: document.getElementById('name').value,
            customer_id: parseInt(document.getElementById('customer_id').value),
            position: document.getElementById('position').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            is_primary: document.getElementById('is_primary').checked
        };

        try {
            if (id) {
                await apiRequest(`/contacts/api/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                showToast(t('message.success'), 'success');
            } else {
                await apiRequest('/contacts/api/create', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                showToast(t('message.success'), 'success');
            }

            closeModal();
            loadContacts(currentPage);
        } catch (error) {
            console.error('Failed to save contact:', error);
        }
    }

    async function deleteContact(id) {
        if (!confirm(t('message.confirm_delete'))) return;

        try {
            await apiRequest(`/contacts/api/${id}`, { method: 'DELETE' });
            showToast(t('message.success'), 'success');
            loadContacts(currentPage);
        } catch (error) {
            console.error('Failed to delete contact:', error);
        }
    }

    function closeModal() {
        if (modal) {
            modal.close();
        } else {
            console.error('Modal not initialized');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadContacts();
    });
</script>
{% endblock %}